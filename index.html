<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visualizador 3D iOS</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* Impede zoom e scroll no iOS */
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Overlay Inicial para desbloquear Audio no iOS */
        #overlay-start {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .start-btn {
            padding: 20px 40px;
            border: 2px solid #00ff88;
            color: #00ff88;
            font-size: 1.5rem;
            background: transparent;
            border-radius: 50px;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        /* Interface Principal */
        #ui-container {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 90%;
            max-width: 500px;
            background: rgba(20, 20, 20, 0.8); /* Mais escuro para contraste */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            transition: opacity 0.3s;
            opacity: 0; /* Começa invisível até clicar no Start */
            pointer-events: none; 
        }
        #ui-container.active {
            opacity: 1;
            pointer-events: auto;
        }

        #track-name {
            font-size: 0.9rem;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            margin-bottom: 5px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 15px;
        }

        .btn-upload {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-play {
            background: #00ff88;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: #000;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        /* Esconde input file */
        #file-input { display: none; }
        
        /* Elemento de Audio Oculto */
        #audio-element { display: none; }
    </style>
</head>
<body>

    <div id="overlay-start">
        <div class="start-btn">Toque para Iniciar</div>
        <div style="margin-top: 15px; opacity: 0.7; font-size: 0.8rem;">Necessário para ativar o áudio</div>
    </div>

    <div id="ui-container">
        <div id="track-name">Nenhum arquivo selecionado</div>
        
        <div class="controls-row">
            <label for="file-input" class="btn-upload">
                <i class="fas fa-folder-open"></i> Arquivos
            </label>
            <input type="file" id="file-input" accept="*/*"> 

            <button id="play-btn" class="btn-play">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <div id="canvas-container"></div>
    
    <audio id="audio-element" playsinline webkit-playsinline></audio>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { createNoise3D } from 'https://unpkg.com/simplex-noise@4.0.1/dist/esm/simplex-noise.js';

        // --- Configs ---
        const noise3D = createNoise3D();
        const SPHERE_RADIUS = 18;
        const SPHERE_DETAIL = 40; // Alta qualidade
        
        // --- Globais ---
        let scene, camera, renderer, sphere, controls;
        let audioContext, audioAnalyser, audioSource;
        let dataArray, originalPositions;
        let isInitialized = false;

        const audioElement = document.getElementById('audio-element');
        const playBtn = document.getElementById('play-btn');
        const playIcon = playBtn.querySelector('i');
        const fileInput = document.getElementById('file-input');
        const trackName = document.getElementById('track-name');

        // --- 1. Inicializar 3D ---
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Ajuste de câmera para Mobile
            if (window.innerWidth < 768) {
                camera.position.z = 110;
            } else {
                camera.position.z = 80;
            }

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enablePan = false;

            // Luzes
            scene.add(new THREE.AmbientLight(0x404040, 3));
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(10, 10, 10);
            scene.add(light);

            // Esfera
            const geometry = new THREE.IcosahedronGeometry(SPHERE_RADIUS, SPHERE_DETAIL);
            const material = new THREE.MeshStandardMaterial({
                color: 0x00ff88,
                wireframe: true,
                roughness: 0.0,
                metalness: 0.5
            });

            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            originalPositions = geometry.attributes.position.array.slice();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        // --- 2. Sistema de Áudio (Híbrido HTML5 + WebAudio) ---
        function initAudioContext() {
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                
                // Cria o analisador
                audioAnalyser = audioContext.createAnalyser();
                audioAnalyser.fftSize = 256; // Menor = mais rápido no mobile
                dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);

                // Conecta o elemento <audio> ao WebAudio
                // Isso permite tocar arquivos grandes sem travar o celular
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(audioAnalyser);
                audioAnalyser.connect(audioContext.destination);
            }
            
            // Importante para iOS: Resumir contexto se estiver suspenso
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // --- 3. Eventos ---
        
        // Botão Inicial (Obrigatório no iOS)
        document.getElementById('overlay-start').addEventListener('click', function() {
            initAudioContext(); // Cria o contexto no clique do usuário
            this.style.display = 'none';
            document.getElementById('ui-container').classList.add('active');
            isInitialized = true;
            initThree();
        });

        // Upload de Arquivo
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Usa URL.createObjectURL (Streaming local) em vez de FileReader (RAM)
            // Isso resolve o problema de "nada acontece" com vídeos grandes
            const fileURL = URL.createObjectURL(file);
            
            audioElement.src = fileURL;
            trackName.innerText = file.name;
            
            audioElement.play().then(() => {
                updatePlayButton(true);
            }).catch(err => {
                console.log("Erro autoplay (normal em browsers):", err);
                updatePlayButton(false);
            });
        });

        // Botão Play/Pause
        playBtn.addEventListener('click', () => {
            if (!isInitialized) return;

            // Sempre tentar resumir o contexto no clique
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (audioElement.paused) {
                audioElement.play();
                updatePlayButton(true);
            } else {
                audioElement.pause();
                updatePlayButton(false);
            }
        });

        function updatePlayButton(playing) {
            if (playing) {
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-pause');
            } else {
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            }
        }

        // --- 4. Animação ---
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            let audioLevel = 0;

            if (audioAnalyser && !audioElement.paused) {
                audioAnalyser.getByteFrequencyData(dataArray);
                
                // Pega a média dos graves
                let sum = 0;
                // Analisa apenas os primeiros 10 bins (graves profundos)
                for(let i = 0; i < 10; i++) {
                    sum += dataArray[i];
                }
                audioLevel = (sum / 10) / 255; // 0.0 a 1.0
                
                // Cor Reativa
                const hue = 0.3 + (audioLevel * 0.3); // Verde -> Azul
                sphere.material.color.setHSL(hue, 1.0, 0.5);
            }

            // Deformação da Esfera
            const positionAttribute = sphere.geometry.attributes.position;
            const vertex = new THREE.Vector3();

            for (let i = 0; i < positionAttribute.count; i++) {
                const ox = originalPositions[i * 3];
                const oy = originalPositions[i * 3 + 1];
                const oz = originalPositions[i * 3 + 2];

                vertex.set(ox, oy, oz);
                vertex.normalize();

                // Noise orgânico suave
                let noise = noise3D(
                    vertex.x + time * 0.0005,
                    vertex.y + time * 0.0005,
                    vertex.z + time * 0.0005
                );

                // Raio base + pulsação do áudio
                let dist = SPHERE_RADIUS + (noise * 2);
                
                if (audioLevel > 0) {
                    // Distorção agressiva na batida
                    dist += audioLevel * 5 * (noise + 1); 
                    dist += audioLevel * 2; // Expansão geral
                }

                vertex.multiplyScalar(dist);
                positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
            }

            sphere.geometry.attributes.position.needsUpdate = true;
            sphere.geometry.computeVertexNormals();
            
            sphere.rotation.y += 0.002;
            
            if(renderer) renderer.render(scene, camera);
            if(controls) controls.update();
        }

    </script>
</body>
</html>
